<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Hate Agency – CRM Contacts MVP</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at top left, #0f172a, #1e293b);
      color: #f1f5f9;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(30,41,59,0.6);
      border-radius: 20px;
      padding: 20px;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    }

    .brand {
      text-align: center;
      font-size: 34px;
      font-weight: 700;
      margin-bottom: 20px;
      letter-spacing: 2px;

      background: linear-gradient(90deg, #38bdf8, #818cf8, #a855f7);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      -webkit-text-fill-color: transparent;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    input, select, button {
      padding: 10px;
      border-radius: 10px;
      border: none;
      outline: none;
    }

    input, select {
      background: rgba(255,255,255,0.1);
      color: #f1f5f9;
    }

    input::placeholder {
      color: #cbd5e1;
    }

    button {
      background: linear-gradient(90deg, #38bdf8, #818cf8, #a855f7);
      color: #0f172a;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      box-shadow: 0 0 15px #38bdf8;
      transform: translateY(-2px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: left;
    }

    tr:nth-child(even) {
      background: rgba(255,255,255,0.05);
    }

    tr:hover {
      background: rgba(56,189,248,0.1);
    }

    .filter {
      margin-bottom: 15px;
    }

    /* Стили выпадашек */
    select option { background:#0f172a; color:#f1f5f9; }
    select option:checked {
      background: linear-gradient(90deg, #38bdf8, #818cf8, #a855f7);
      color:#0f172a;
    }
    select option:hover { background:rgba(56,189,248,0.2); color:#f1f5f9; }

    .delete-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    .delete-btn:hover { background: #dc2626; }
  </style>
</head>
<body>
  <div class="container">
    <div class="brand">⚡ Hate Agency CRM</div>

    <!-- Форма добавления -->
    <form id="addContactForm">
      <input type="text" name="name" placeholder="Имя" required>
      <input type="email" name="email" placeholder="Email" required>
      <input type="text" name="phone" placeholder="Телефон" required>
      <select name="status" required>
        <option value="active">Активный</option>
        <option value="inactive">Неактивный</option>
      </select>
      <button type="submit">Добавить</button>
    </form>

    <!-- Фильтр -->
    <div class="filter">
      <label for="statusFilter">Фильтр по статусу:</label>
      <select id="statusFilter">
        <option value="all">Все</option>
        <option value="active">Активные</option>
        <option value="inactive">Неактивные</option>
      </select>
    </div>

    <!-- Таблица -->
    <table id="contactsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Имя</th>
          <th>Email</th>
          <th>Телефон</th>
          <th>Статус</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Нормализация произвольных значений статуса к 'active' / 'inactive'
    function normalizeStatus(value) {
      const s = (value ?? '').toString().trim().toLowerCase();
      if (['active','активный','активен','активна','1','true','yes','да'].includes(s)) return 'active';
      if (['inactive','неактивный','не активный','0','false','no','нет'].includes(s)) return 'inactive';
      // если непонятно — считаем неактивным (или поменяй на 'active', как нужно)
      return 'inactive';
    }

    function prettyStatus(value) {
      return normalizeStatus(value) === 'active' ? 'Активный' : 'Неактивный';
    }

    async function fetchContacts() {
      const res = await fetch('/contacts', { cache: 'no-store' });
      const data = await res.json();
      // добавим нормализованное поле один раз, чтобы не считать каждый раз
      return Array.isArray(data) ? data.map(c => ({
        ...c,
        _normStatus: normalizeStatus(c.status)
      })) : [];
    }

    async function loadContacts() {
      const contacts = await fetchContacts();
      const filter = document.getElementById('statusFilter').value;

      let filtered = contacts;
      if (filter === 'active') {
        filtered = contacts.filter(c => c._normStatus === 'active');
      } else if (filter === 'inactive') {
        filtered = contacts.filter(c => c._normStatus === 'inactive');
      }

      const tbody = document.querySelector('#contactsTable tbody');
      tbody.innerHTML = '';

      filtered.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${c.id}</td>
           <td>${c.name ?? ''}</td>
           <td>${c.email ?? ''}</td>
           <td>${c.phone ?? ''}</td>
           <td>${prettyStatus(c.status)}</td>
           <td><button class="delete-btn" onclick="deleteContact(${Number(c.id)})">Удалить</button></td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('addContactForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      // нормализуем статус перед отправкой на сервер
      const raw = Object.fromEntries(formData.entries());
      const payload = { ...raw, status: normalizeStatus(raw.status) };

      const res = await fetch('/add-contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        e.target.reset();
        await loadContacts();
      }
    });

    async function deleteContact(id) {
      if (!Number.isFinite(id)) return;
      if (confirm("Удалить контакт?")) {
        const res = await fetch(`/delete-contact/${id}`, { method: 'DELETE' });
        if (res.ok) await loadContacts();
      }
    }

    // при смене фильтра — перерисовываем
    document.getElementById('statusFilter').addEventListener('change', loadContacts);

    // первичная загрузка
    loadContacts();
  </script>
</body>
</html>
